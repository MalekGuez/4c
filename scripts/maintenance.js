#!/usr/bin/env node

/**
 * Script pour activer/dÃ©sactiver le mode maintenance
 * Usage: node scripts/maintenance.js [on|off|status]
 */

const fs = require('fs');
const path = require('path');

const ENV_FILE = path.join(__dirname, '..', '.env.local');
const MAINTENANCE_KEY = 'NEXT_PUBLIC_MAINTENANCE_MODE';

function readEnvFile() {
  if (!fs.existsSync(ENV_FILE)) {
    return {};
  }
  
  const content = fs.readFileSync(ENV_FILE, 'utf-8');
  const env = {};
  
  content.split('\n').forEach(line => {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key) {
        env[key.trim()] = valueParts.join('=').trim();
      }
    }
  });
  
  return env;
}

function writeEnvFile(env) {
  const lines = [
    '# Environment Variables',
    '# Generated by maintenance script',
    '',
  ];
  
  Object.entries(env).forEach(([key, value]) => {
    lines.push(`${key}=${value}`);
  });
  
  fs.writeFileSync(ENV_FILE, lines.join('\n') + '\n', 'utf-8');
}

function getMaintenanceStatus() {
  const env = readEnvFile();
  return env[MAINTENANCE_KEY] === 'true';
}

function setMaintenanceMode(enabled) {
  const env = readEnvFile();
  env[MAINTENANCE_KEY] = enabled ? 'true' : 'false';
  
  // Ensure API URL is set
  if (!env.NEXT_PUBLIC_API_URL) {
    env.NEXT_PUBLIC_API_URL = 'http://localhost:8080/api';
  }
  
  writeEnvFile(env);
}

function showStatus() {
  const isEnabled = getMaintenanceStatus();
  console.log('\nðŸ”§ Mode Maintenance Status:');
  console.log(`   ${isEnabled ? 'ðŸ”´ ACTIVÃ‰' : 'ðŸŸ¢ DÃ‰SACTIVÃ‰'}`);
  console.log('');
  
  if (isEnabled) {
    console.log('   Le site affiche la page de maintenance.');
    console.log('   Pour dÃ©sactiver: node scripts/maintenance.js off');
  } else {
    console.log('   Le site fonctionne normalement.');
    console.log('   Pour activer: node scripts/maintenance.js on');
  }
  console.log('');
}

function main() {
  const command = process.argv[2];
  
  switch (command) {
    case 'on':
      setMaintenanceMode(true);
      console.log('\nâœ… Mode maintenance ACTIVÃ‰');
      console.log('   Le site affichera la page de maintenance.');
      console.log('   RedÃ©marrez le serveur de dÃ©veloppement si nÃ©cessaire.\n');
      break;
      
    case 'off':
      setMaintenanceMode(false);
      console.log('\nâœ… Mode maintenance DÃ‰SACTIVÃ‰');
      console.log('   Le site fonctionne normalement.');
      console.log('   RedÃ©marrez le serveur de dÃ©veloppement si nÃ©cessaire.\n');
      break;
      
    case 'status':
      showStatus();
      break;
      
    default:
      console.log('\nðŸ”§ Script de gestion du mode maintenance\n');
      console.log('Usage:');
      console.log('  node scripts/maintenance.js on      - Activer la maintenance');
      console.log('  node scripts/maintenance.js off     - DÃ©sactiver la maintenance');
      console.log('  node scripts/maintenance.js status  - Voir le statut actuel');
      console.log('');
      showStatus();
  }
}

main();
